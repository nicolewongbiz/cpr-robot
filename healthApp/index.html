<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioStat | Liquid Glass</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/smoothie/1.34.0/smoothie.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            /* Apple Mesh Gradient Background */
            background: radial-gradient(at 0% 0%, #ffdee9 0%, transparent 50%),
                        radial-gradient(at 100% 0%, #b5fffc 0%, transparent 50%),
                        radial-gradient(at 100% 100%, #e0c3fc 0%, transparent 50%),
                        radial-gradient(at 0% 100%, #8ec5fc 0%, transparent 50%);
            background-color: #f5f5f7;
            background-attachment: fixed;
            color: #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 360px;
        }

        /* Liquid Glass Containers */
        .card, .model-container {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border-radius: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            overflow: hidden;
            position: relative;
        }

        .model-container { height: 300px; }
        .card { padding: 24px; box-sizing: border-box; }

        #canvas-container { width: 100%; height: 100%; }

        .label {
            font-size: 14px;
            font-weight: 700;
            color: #6a737d;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .value-text {
            font-size: 52px;
            font-weight: 900;
            margin: 0;
        }

        #hr-val { color: #d73a49; }
        #br-val { color: #0366d6; }

        canvas.data-chart {
        width: 100% !important;
        height: 80px !important;
        /* Remove solid background, use subtle glass tint instead */
        background: rgba(255, 255, 255, 0.05) !important;
        margin-top: 15px;
        border-radius: 12px;
        /* Adds a slight inner border to define the chart area within the glass */
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

        #status {
            font-weight: 700;
            margin-bottom: 15px;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        #loading-indicator {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
            z-index: 100;
            pointer-events: none;
        }

        #loading-indicator.hidden { display: none; }
    </style>
</head>
<body>

    <div id="status">CONNECTING...</div>

    <div class="container">
        <div class="model-container">
            <div id="loading-indicator">Loading 3D model...</div>
            <div id="canvas-container"></div>
        </div>

        <div class="card">
            <div class="label">Heart Rate (BPM)</div>
            <div id="hr-val" class="value-text">--</div>
            <canvas id="hr-chart" class="data-chart"></canvas>
        </div>

        <div class="card">
            <div class="label">Respiration (RPM)</div>
            <div id="br-val" class="value-text">--</div>
            <canvas id="br-chart" class="data-chart"></canvas>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const socket = io();
        const hrSeries = new TimeSeries();
        const brSeries = new TimeSeries();

        let scene, camera, renderer, controls, model, mixer;
        let clock = new THREE.Clock();
        let heartScale = 1.0, targetScale = 1.0, scaleLerpSpeed = 0.15;

        function init() {
            scene = new THREE.Scene();
            scene.background = null; // Essential for glass effect

            const container = document.getElementById('canvas-container');
            camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 4.5); 
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.5;
            container.appendChild(renderer.domElement);
            
            scene.add(new THREE.AmbientLight(0xffffff, 0.5));
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 5, 5);
            scene.add(directionalLight);
            
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.enableZoom = true;
            
            loadModel();
            animate();
            window.addEventListener('resize', onWindowResize);
        }

        function loadModel() {
            const loader = new GLTFLoader();
            loader.load('models/heart.glb', (gltf) => {
                model = gltf.scene;

                // --- SUPER TRANSLUCENT GLASS OVERRIDE ---
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.material = new THREE.MeshPhysicalMaterial({
                            // Desaturated Apple Rose and Soft Azure
                            color: child.name.toLowerCase().includes('blue') ? 0x7db9f2 : 0xf2a7b5, 
                            metalness: 0.05,
                            roughness: 0.02,
                            transmission: 0.95, 
                            ior: 1.45,
                            thickness: 0.8,
                            transparent: true,
                            opacity: 0.6, 
                            clearcoat: 1.0
                        });
                    }
                });

                scene.add(model);
                const box = new THREE.Box3().setFromObject(model);
                const center = box.getCenter(new THREE.Vector3());
                model.position.sub(center);
                
                const size = box.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 3.2 / maxDim;
                model.scale.multiplyScalar(scale);

                if (gltf.animations.length > 0) {
                    mixer = new THREE.AnimationMixer(model);
                    gltf.animations.forEach(clip => mixer.clipAction(clip).play());
                }
                document.getElementById('loading-indicator').classList.add('hidden');
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);
            
            if (model) {
                heartScale += (targetScale - heartScale) * scaleLerpSpeed;
                model.scale.setScalar(3.2 / 1.0 * heartScale);
            }

            controls.update();
            renderer.render(scene, camera);
        }

        function initChart(id, series, color) {
            const chart = new SmoothieChart({
                grid: { strokeStyle: 'rgba(0,0,0,0.05)', verticalSections: 0, borderVisible: false },
                labels: { disabled: true },
                maxValue: 120, minValue: 40
            });
            chart.addTimeSeries(series, { strokeStyle: color, lineWidth: 4 });
            chart.streamTo(document.getElementById(id), 1000);
        }

        initChart('hr-chart', hrSeries, '#d73a49');
        initChart('br-chart', brSeries, '#0366d6');

        socket.on('connect', () => {
            document.getElementById('status').innerText = "â— SYSTEM ACTIVE";
            document.getElementById('status').style.color = "#28a745";
        });

        socket.on('update_data', (data) => {
            document.getElementById('hr-val').innerText = data.hr;
            document.getElementById('br-val').innerText = data.br;
            targetScale = 1.15;
            setTimeout(() => targetScale = 1.0, 150);
            const now = new Date().getTime();
            hrSeries.append(now, data.hr);
            brSeries.append(now, data.br);
        });

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        init();
    </script>
</body>
</html>