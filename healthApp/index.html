<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioStat | Premium</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/smoothie/1.34.0/smoothie.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: radial-gradient(at 0% 0%, #ffdee9 0%, transparent 50%),
                        radial-gradient(at 100% 0%, #b5fffc 0%, transparent 50%);
            background-color: #f5f5f7;
            display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh;
            overflow-x: hidden;
        }
        .container { width: 100%; max-width: 360px; }
        
        /* Glass UI */
        .card, .model-container {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(25px) saturate(180%);
            border-radius: 24px; margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            overflow: hidden; position: relative;
        }
        .model-container { height: 320px; cursor: grab; }
        .model-container:active { cursor: grabbing; }
        .card { padding: 24px; }
        
        #canvas-container { width: 100%; height: 100%; }
        .label { font-size: 12px; font-weight: 700; color: #6a737d; text-transform: uppercase; }
        .value-text { font-size: 48px; font-weight: 900; margin: 0; transition: transform 0.1s; display: inline-block;}
        #hr-val { color: #d73a49; }
        
        canvas.data-chart { width: 100% !important; height: 80px !important; margin-top: 10px; background: transparent; }
        #status { font-weight: 700; margin-bottom: 15px; padding: 8px 20px; background: rgba(255, 255, 255, 0.5); border-radius: 50px; transition: all 0.3s; }

        /* Emergency Alert Banner */
        #emergency-alert {
            position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
            background: #d73a49; color: white; padding: 12px 24px; border-radius: 50px;
            font-weight: 900; letter-spacing: 1px; box-shadow: 0 10px 20px rgba(215, 58, 73, 0.4);
            display: none; z-index: 2000; animation: pulse-red 1.5s infinite;
        }
        @keyframes pulse-red {
            0% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
            100% { transform: translateX(-50%) scale(1); }
        }

        /* Sidebar Panel */
        #patient-sidebar {
            position: fixed; top: 0; right: -350px; width: 300px; height: 100vh;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(30px);
            z-index: 1000; padding: 30px; transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border-left: 1px solid rgba(255, 255, 255, 0.3); box-shadow: -10px 0 30px rgba(0,0,0,0.05);
        }
        #patient-sidebar.open { right: 0; }
        .toggle-btn {
            position: fixed; top: 20px; right: 20px; z-index: 1001;
            background: white; border: none; padding: 10px 15px; border-radius: 12px;
            cursor: pointer; font-weight: 700; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .record-item { margin-bottom: 20px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 10px; }
        .record-item label { font-size: 10px; color: #666; text-transform: uppercase; }
        .record-item div { font-weight: 700; font-size: 14px; }
    </style>
</head>
<body>

    <button class="toggle-btn" onclick="document.getElementById('patient-sidebar').classList.toggle('open')">â˜° PATIENT</button>
    <div id="emergency-alert">ðŸš¨ 911 CONTACTED - EMERGENCY SERVICES NOTIFIED</div>

    <div id="patient-sidebar">
        <h2 style="margin-top: 40px;">John Doe</h2>
        <p style="color: #666; font-size: 12px; margin-bottom: 30px;">ID: #88-X-992</p>
        <div class="record-item"><label>Condition</label><div>Sinus Tachycardia</div></div>
        <div class="record-item"><label>Medication</label><div>Atenolol 25mg</div></div>
        <div class="record-item"><label>Last Reading</label><div>Stable - 14 Feb 2026</div></div>
        <div class="record-item"><label>Blood Type</label><div>O Positive</div></div>
    </div>

    <div id="status">INITIALIZING...</div>

    <div class="container">
        <div class="model-container">
            <div id="canvas-container"></div>
        </div>

        <div class="card">
            <div class="label">Heart Rate (BPM)</div>
            <div id="hr-val" class="value-text">--</div>
            <canvas id="hr-chart" class="data-chart"></canvas>
        </div>

        <div class="card">
            <div class="label">Real-time Pulse Wave (IR)</div>
            <canvas id="ir-chart" class="data-chart"></canvas>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const socket = io();
        const hrSeries = new TimeSeries();
        const irSeries = new TimeSeries();

        let scene, camera, renderer, model, mixer, controls;
        let clock = new THREE.Clock();
        let baseScale = 1.0, currentScale = 1.0, targetScale = 1.0;

        function init() {
            const container = document.getElementById('canvas-container');
            if (!container) return;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            scene.add(new THREE.AmbientLight(0xffffff, 1.2));
            const spot = new THREE.SpotLight(0xffffff, 3.0);
            spot.position.set(5, 5, 5);
            scene.add(spot);

            const loader = new GLTFLoader();
            loader.load('models/heart.glb', (gltf) => {
                model = gltf.scene;
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.material = new THREE.MeshPhysicalMaterial({
                            color: child.name.toLowerCase().includes('blue') ? 0x7db9f2 : 0xf2a7b5,
                            roughness: 0.5, metalness: 0.1, transparent: false, opacity: 1.0, transmission: 0.0
                        });
                    }
                });
                scene.add(model);
                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3());
                baseScale = 3.5 / Math.max(size.x, size.y, size.z);
                model.scale.setScalar(baseScale);

                if (gltf.animations.length > 0) {
                    mixer = new THREE.AnimationMixer(model);
                    mixer.clipAction(gltf.animations[0]).play();
                }
            });

            initChart('hr-chart', hrSeries, '#d73a49');
            initChart('ir-chart', irSeries, '#0366d6');
            animate();
        }

        function initChart(id, series, color) {
            const chart = new SmoothieChart({
                grid: { strokeStyle: 'rgba(0,0,0,0.05)', verticalSections: 0, borderVisible: false, fillStyle: 'transparent' },
                labels: { disabled: true },
                maxValue: id === 'hr-chart' ? 160 : undefined,
                minValue: id === 'hr-chart' ? 0 : undefined,
                interpolation: 'bezier'
            });

            if (id === 'ir-chart') {
                chart.options.yRangeFunction = (range) => {
                    let margin = (range.max - range.min) * 0.2;
                    return { min: range.min - margin, max: range.max + margin };
                };
            }
            chart.addTimeSeries(series, { strokeStyle: color, lineWidth: 4, fillStyle: 'transparent' });
            chart.streamTo(document.getElementById(id), 1000);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if (controls) controls.update();
            if (mixer) mixer.update(delta);
            if (model) {
                currentScale += (targetScale - currentScale) * 0.3;
                model.scale.setScalar(baseScale * currentScale);
                targetScale += (1.0 - targetScale) * 0.2;
            }
            renderer.render(scene, camera);
        }

        // --- SOCKET EVENTS ---
        socket.on('update_data', (data) => {
            const hrVal = document.getElementById('hr-val');
            if (hrVal) hrVal.innerText = data.hr || "--";
            if (data.beat === 1) {
                targetScale = 1.3;
                if (hrVal) {
                    hrVal.style.transform = "scale(1.2)";
                    setTimeout(() => hrVal.style.transform = "scale(1.0)", 100);
                }
            }
            const now = new Date().getTime();
            hrSeries.append(now, data.hr);
            irSeries.append(now, data.ir); 
        });

        socket.on('emergency_alert', (data) => {
            const alertBox = document.getElementById('emergency-alert');
            if (alertBox) alertBox.style.display = data.active ? 'block' : 'none';
        });

        socket.on('connect', () => {
            const status = document.getElementById('status');
            if (status) { status.innerText = "â— SYSTEM CONNECTED"; status.style.color = "#007aff"; }
        });

        socket.on('disconnect', () => {
            const status = document.getElementById('status');
            if (status) { status.innerText = "â—‹ SYSTEM DISCONNECTED"; status.style.color = "#d73a49"; }
        });

        window.addEventListener('resize', () => {
            const container = document.getElementById('canvas-container');
            if (!container || !renderer || !camera) return;
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });

        init();
    </script>
</body>
</html>