<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioStat | Premium</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/smoothie/1.34.0/smoothie.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            margin: 0; font-family: 'Inter', sans-serif;
            background: radial-gradient(at 0% 0%, #ffdee9 0%, transparent 50%),
                        radial-gradient(at 100% 0%, #b5fffc 0%, transparent 50%),
                        #f5f5f7;
            display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh;
        }
        .container { width: 100%; max-width: 360px; }
        .card, .model-container {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(25px) saturate(180%);
            border-radius: 24px; margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            overflow: hidden; position: relative;
        }
        .model-container { height: 320px; }
        .card { padding: 24px; }
        #canvas-container { width: 100%; height: 100%; }
        .label { font-size: 12px; font-weight: 700; color: #6a737d; text-transform: uppercase; }
        .value-text { font-size: 48px; font-weight: 900; margin: 0; transition: transform 0.1s; }
        #hr-val { color: #d73a49; }
        canvas.data-chart { width: 100% !important; height: 80px !important; margin-top: 10px; }
        #status { font-weight: 700; margin-bottom: 15px; padding: 8px 20px; background: rgba(255, 255, 255, 0.5); border-radius: 50px; }
    </style>
</head>
<body>

    <div id="status">CONNECTING...</div>

    <div class="container">
        <div class="model-container">
            <div id="canvas-container"></div>
        </div>

        <div class="card">
            <div class="label">Heart Rate (BPM)</div>
            <div id="hr-val" class="value-text">--</div>
            <canvas id="hr-chart" class="data-chart"></canvas>
        </div>

        <div class="card">
            <div class="label">Live Pulse (IR)</div>
            <canvas id="ir-chart" class="data-chart"></canvas>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        const socket = io();
        const hrSeries = new TimeSeries();
        const irSeries = new TimeSeries();

        let scene, camera, renderer, model, mixer;
        let clock = new THREE.Clock();
        let baseScale = 1.0, currentScale = 1.0, targetScale = 1.0;

        function init() {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 0, 5);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // High Quality Lighting
            scene.add(new THREE.AmbientLight(0xffffff, 1.0));
            const spot = new THREE.SpotLight(0xffffff, 2.0);
            spot.position.set(5, 5, 5);
            scene.add(spot);

            const loader = new GLTFLoader();
            loader.load('models/heart.glb', (gltf) => {
                model = gltf.scene;
                
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.material = new THREE.MeshPhysicalMaterial({
                            color: child.name.toLowerCase().includes('blue') ? 0x7db9f2 : 0xf2a7b5,
                            transmission: 0.9, thickness: 1.5, roughness: 0.1,
                            transparent: true, opacity: 0.8, ior: 1.5
                        });
                    }
                });

                scene.add(model);
                const box = new THREE.Box3().setFromObject(model);
                const size = box.getSize(new THREE.Vector3());
                baseScale = 3.5 / Math.max(size.x, size.y, size.z);
                model.scale.setScalar(baseScale);

                if (gltf.animations.length > 0) {
                    mixer = new THREE.AnimationMixer(model);
                    mixer.clipAction(gltf.animations[0]).play();
                }
            });

            // Setup Charts
            initChart('hr-chart', hrSeries, '#d73a49');
            initChart('ir-chart', irSeries, '#0366d6');

            animate();
        }

        function initChart(id, series, color) {
            const chart = new SmoothieChart({
                grid: { 
                    strokeStyle: 'rgba(255,255,255,0.1)', // Subtle grid lines
                    verticalSections: 0, 
                    borderVisible: false,
                    fillStyle: 'transparent' // REMOVES BLACK BACKGROUND
                },
                labels: { disabled: true },
                // Enable tooltip-like behavior or auto-scaling
                maxValue: id === 'hr-chart' ? 160 : undefined, // Fixed for BPM
                minValue: id === 'hr-chart' ? 0 : undefined,   // Fixed for BPM
                millisPerPixel: 20,
                interpolation: 'bezier'
            });
            
            // For the IR chart, we enable auto-scaling to see the wave clearly
            if (id === 'ir-chart') {
                chart.options.yRangeFunction = function(range) {
                    // This creates a "zoom" effect on the IR wave
                    let margin = (range.max - range.min) * 0.2;
                    return { min: range.min - margin, max: range.max + margin };
                };
            }

            chart.addTimeSeries(series, { 
                strokeStyle: color, 
                lineWidth: 4, 
                fillStyle: 'transparent' // No solid fill under the line
            });
            chart.streamTo(document.getElementById(id), 1000);
        }

        

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);

            if (model) {
                // Smooth scale pulse logic
                currentScale += (targetScale - currentScale) * 0.3;
                model.scale.setScalar(baseScale * currentScale);
                targetScale += (1.0 - targetScale) * 0.2;
            }
            renderer.render(scene, camera);
        }

        // --- UPDATE DATA HANDLER ---
        socket.on('update_data', (data) => {
            const hrVal = document.getElementById('hr-val');
            hrVal.innerText = data.hr || "--";
            
            if (data.beat === 1) {
                targetScale = 1.3;
                hrVal.style.transform = "scale(1.2)";
                setTimeout(() => hrVal.style.transform = "scale(1.0)", 100);
            }

            const now = new Date().getTime();
            hrSeries.append(now, data.hr);
            
            // Raw IR values are usually large (e.g., 50000). 
            // We pass it directly so the auto-scaler can find the peaks.
            irSeries.append(now, data.ir); 
        });

        socket.on('connect', () => {
            document.getElementById('status').innerText = "‚óè SYSTEM ACTIVE";
            document.getElementById('status').style.color = "#28a745";
        });

        init();
    </script>
</body>
</html>